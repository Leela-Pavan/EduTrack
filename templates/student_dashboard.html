{% extends "base.html" %}

{% block title %}Student Dashboard - School Management System{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Left Sidebar -->
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user me-2"></i>Profile
                    </h5>
                </div>
                <div class="card-body text-center">
                    <div class="profile-image-container mb-3">
                        {% if student[8] %}
                            <img id="profileImage" src="{{ student[8] }}" 
                                 alt="Profile Picture" class="profile-image" 
                                 style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #007bff;">
                        {% else %}
                            <div id="profileImage" class="profile-image d-flex align-items-center justify-content-center" 
                                 style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: 3px solid #007bff; color: white; font-size: 36px; font-weight: bold;">
                                {{ student[3][0] }}{{ student[4][0] }}
                            </div>
                        {% endif %}
                        <div class="mt-2">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" id="photoOptions" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-camera me-1"></i>Change Photo
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="photoOptions">
                                    <li><a class="dropdown-item" href="#" onclick="changeProfilePicture()">
                                        <i class="fas fa-folder-open me-2"></i>Choose from Files
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="openCameraModal()">
                                        <i class="fas fa-camera me-2"></i>Take Photo with Camera
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <h6 class="card-title">{{ student[3] }} {{ student[4] }}</h6>
                    <p class="text-muted">{{ student[5] }}-{{ student[6] }}</p>
                    <button class="btn btn-primary btn-sm" onclick="showProfileModal()">
                        <i class="fas fa-edit me-1"></i>Edit Profile
                    </button>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-calendar-check me-1"></i>View Attendance
                        </button>
                        <button class="btn btn-outline-success btn-sm">
                            <i class="fas fa-book me-1"></i>View Grades
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="showScheduleModal()">
                            <i class="fas fa-clock me-1"></i>Class Schedule
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-md-9">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-user-graduate me-2"></i>Welcome, {{ student[3] }} {{ student[4] }}
                </h1>
                <div class="text-muted">
                    <i class="fas fa-calendar me-1"></i>{{ current_date }}
                </div>
            </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ attendance_summary[1] or 0 }}</h4>
                            <p class="card-text">Present Days</p>
                        </div>
                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ attendance_summary[2] or 0 }}</h4>
                            <p class="card-text">Absent Days</p>
                        </div>
                        <i class="fas fa-times-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ free_periods|length }}</h4>
                            <p class="card-text">Free Periods Today</p>
                        </div>
                        <i class="fas fa-clock fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ suggested_tasks|length }}</h4>
                            <p class="card-text">Suggested Tasks</p>
                        </div>
                        <i class="fas fa-tasks fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Today's Timetable -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar-day me-2"></i>Today's Schedule
                    </h5>
                </div>
                <div class="card-body">
                    {% if timetable %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Period</th>
                                    <th>Time</th>
                                    <th>Subject</th>
                                    <th>Teacher & Room</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for period in range(1, 9) %}
                                {% set period_info = timetable|selectattr('4', 'equalto', period)|first %}
                                <tr class="{% if period in free_periods %}table-light{% endif %}">
                                    <td><strong>{{ period }}</strong></td>
                                    <td>
                                        {% if period_info %}
                                            <small class="text-muted">{{ period_info[7] }} - {{ period_info[8] }}</small>
                                        {% else %}
                                            <small class="text-muted">Free Period</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if period_info %}
                                            {% set subject_parts = period_info[5].split(' (') %}
                                            <strong class="text-primary">{{ subject_parts[0] }}</strong>
                                        {% else %}
                                            <span class="text-muted">Free</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if period_info %}
                                            {% set subject_full = period_info[5] %}
                                            {% if '(' in subject_full and ')' in subject_full %}
                                                {% set teacher_room = subject_full.split('(')[1].replace(')', '') %}
                                                {% if ' - ' in teacher_room %}
                                                    {% set teacher = teacher_room.split(' - ')[0] %}
                                                    {% set room = teacher_room.split(' - ')[1] %}
                                                    <div>
                                                        <small class="text-success"><i class="fas fa-user-tie me-1"></i>{{ teacher }}</small><br>
                                                        <small class="text-info"><i class="fas fa-map-marker-alt me-1"></i>{{ room }}</small>
                                                    </div>
                                                {% else %}
                                                    <small class="text-muted">{{ teacher_room }}</small>
                                                {% endif %}
                                            {% else %}
                                                <small class="text-muted">TBA</small>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if period_info %}
                                            {% set current_time = moment().format('HH:mm') %}
                                            {% set start_time = period_info[7] %}
                                            {% set end_time = period_info[8] %}
                                            
                                            {% if period_info[5].startswith('Sports') %}
                                                <span class="badge bg-warning text-dark">
                                                    <i class="fas fa-running me-1"></i>Sports
                                                </span>
                                            {% elif 'LAB' in period_info[5].upper() %}
                                                <span class="badge bg-info">
                                                    <i class="fas fa-laptop-code me-1"></i>Lab
                                                </span>
                                            {% else %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-chalkboard-teacher me-1"></i>Class
                                                </span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-coffee me-1"></i>Free
                                            </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Current Period Highlight -->
                    <div class="mt-3 p-3 bg-light rounded">
                        <h6 class="text-primary mb-2">
                            <i class="fas fa-clock me-2"></i>Current Time Status
                        </h6>
                        <div id="current-status">
                            <small class="text-muted">Loading current period...</small>
                        </div>
                    </div>
                    
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No classes scheduled for today</h5>
                        <p class="text-muted mb-3">Enjoy your free day!</p>
                        <small class="text-muted">
                            Today is {{ current_date.split(',')[0] }}
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Quick Actions & Free Periods -->
        <div class="col-lg-4 mb-4">
            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('attendance_qr') }}" class="btn btn-primary">
                            <i class="fas fa-qrcode me-2"></i>Mark Attendance
                        </a>
                        <button class="btn btn-outline-primary" onclick="generateDailyRoutine()">
                            <i class="fas fa-magic me-2"></i>Generate Daily Routine
                        </button>
                        <button class="btn btn-outline-success" onclick="viewProgress()">
                            <i class="fas fa-chart-line me-2"></i>View Progress
                        </button>
                    </div>
                </div>
            </div>

            <!-- Free Periods -->
            {% if free_periods %}
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clock me-2"></i>Free Periods Today
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for period in free_periods %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Period {{ period }}</span>
                            <button class="btn btn-sm btn-outline-primary" onclick="suggestActivity({{ period }})">
                                <i class="fas fa-lightbulb me-1"></i>Suggest
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Suggested Tasks -->
    {% if suggested_tasks %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tasks me-2"></i>Suggested Tasks for Free Periods
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for task in suggested_tasks %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card h-100 border-start border-{{ 'danger' if task[5] == 'high' else 'warning' if task[5] == 'medium' else 'success' }} border-4">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="card-title">{{ task[2] }}</h6>
                                        <span class="badge bg-{{ 'danger' if task[5] == 'high' else 'warning' if task[5] == 'medium' else 'success' }}">
                                            {{ task[5].title() }}
                                        </span>
                                    </div>
                                    <p class="card-text text-muted small">{{ task[3] }}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>{{ task[6] }} min
                                        </small>
                                        <small class="text-muted">{{ task[4] }}</small>
                                    </div>
                                </div>
                                <div class="card-footer bg-transparent">
                                    <button class="btn btn-sm btn-outline-primary w-100" onclick="startTask({{ task[0] }})">
                                        <i class="fas fa-play me-1"></i>Start Task
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Daily Routine Modal -->
<div class="modal fade" id="dailyRoutineModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-magic me-2"></i>Your Daily Smart Routine
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="routineContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Generating routine...</span>
                        </div>
                        <p class="mt-2">Generating your personalized daily routine...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveRoutine()">
                    <i class="fas fa-save me-1"></i>Save Routine
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Profile Edit Modal -->
<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="profileModalLabel">
                    <i class="fas fa-user-edit me-2"></i>Edit Profile
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="profileForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="firstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="firstName" value="{{ student[3] }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="lastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="lastName" value="{{ student[4] }}" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="studentId" class="form-label">Student ID</label>
                            <input type="text" class="form-control" id="studentId" value="{{ student[2] }}" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" value="{{ session.get('email', '') }}" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="department" class="form-label">Department</label>
                            <select class="form-control" id="department" required>
                                <option value="CSIT" {{ 'selected' if student[5] == 'CSIT' }}>CSIT</option>
                                <option value="CSD" {{ 'selected' if student[5] == 'CSD' }}>CSD</option>
                                <option value="CSE" {{ 'selected' if student[5] == 'CSE' }}>CSE</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="section" class="form-label">Section</label>
                            <select class="form-control" id="section" required>
                                <option value="A" {{ 'selected' if student[6] == 'A' }}>A</option>
                                <option value="B" {{ 'selected' if student[6] == 'B' }}>B</option>
                                <option value="C" {{ 'selected' if student[6] == 'C' }}>C</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="year" class="form-label">Year</label>
                            <select class="form-control" id="year" required>
                                <option value="1">1st Year</option>
                                <option value="2" selected>2nd Year</option>
                                <option value="3">3rd Year</option>
                                <option value="4">4th Year</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="dateOfBirth" class="form-label">Date of Birth</label>
                            <input type="date" class="form-control" id="dateOfBirth">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="mobile" class="form-label">Mobile Number</label>
                            <input type="tel" class="form-control" id="mobile" value="{{ student[7] if student[7] else '' }}">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Camera Modal -->
<div class="modal fade" id="cameraModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-camera me-2"></i>Take Profile Photo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="camera-container mb-3">
                    <video id="cameraVideo" width="400" height="300" autoplay style="border-radius: 10px; border: 2px solid #007bff;"></video>
                    <canvas id="cameraCanvas" width="400" height="300" style="display: none;"></canvas>
                </div>
                <div class="camera-controls">
                    <button class="btn btn-success me-2" id="captureBtn" onclick="capturePhoto()">
                        <i class="fas fa-camera me-1"></i>Capture Photo
                    </button>
                    <button class="btn btn-warning me-2" id="retakeBtn" onclick="retakePhoto()" style="display: none;">
                        <i class="fas fa-redo me-1"></i>Retake
                    </button>
                    <button class="btn btn-primary" id="usePhotoBtn" onclick="useProfilePhoto()" style="display: none;">
                        <i class="fas fa-check me-1"></i>Use This Photo
                    </button>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Make sure you're in good lighting for the best photo quality.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden file input for profile picture upload -->
<input type="file" id="hiddenProfileInput" accept="image/*" style="display: none;" onchange="uploadSelectedProfilePicture()">

<!-- Class Schedule Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scheduleModalLabel">
                    <i class="fas fa-calendar-week me-2"></i>{{ student[5] }}-{{ student[6] }} Weekly Schedule
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="scheduleLoadingSpinner" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading schedule...</span>
                    </div>
                    <p class="mt-2">Loading your class schedule...</p>
                </div>
                
                <div id="scheduleContent" style="display: none;">
                    <!-- Schedule will be loaded here via JavaScript -->
                </div>
                
                <div id="scheduleError" style="display: none;" class="text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <p class="text-muted">No schedule found for your class. Please contact your administrator.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="printSchedule()">
                    <i class="fas fa-print me-1"></i>Print Schedule
                </button>
            </div>
        </div>
    </div>
</div>

</div>
{% endblock %}

{% block scripts %}
<script>
function generateDailyRoutine() {
    const modal = new bootstrap.Modal(document.getElementById('dailyRoutineModal'));
    modal.show();
    
    // Simulate routine generation
    setTimeout(() => {
        const content = `
            <div class="timeline">
                <div class="timeline-item">
                    <div class="timeline-marker bg-primary"></div>
                    <div class="timeline-content">
                        <h6>Morning Preparation (7:00 AM - 8:00 AM)</h6>
                        <p class="text-muted">Review today's schedule and prepare materials</p>
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-marker bg-success"></div>
                    <div class="timeline-content">
                        <h6>Classes (8:00 AM - 2:00 PM)</h6>
                        <p class="text-muted">Attend scheduled classes and mark attendance</p>
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-marker bg-warning"></div>
                    <div class="timeline-content">
                        <h6>Free Period Activities (11:15 AM - 12:00 PM)</h6>
                        <p class="text-muted">• Practice Math problems (30 min)<br>• Read literature (15 min)</p>
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-marker bg-info"></div>
                    <div class="timeline-content">
                        <h6>Afternoon Study (2:00 PM - 4:00 PM)</h6>
                        <p class="text-muted">Complete assignments and review class notes</p>
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-marker bg-secondary"></div>
                    <div class="timeline-content">
                        <h6>Skill Development (4:00 PM - 5:00 PM)</h6>
                        <p class="text-muted">Work on coding project or creative writing</p>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('routineContent').innerHTML = content;
    }, 2000);
}

function suggestActivity(period) {
    const activities = [
        "Practice Math problems",
        "Read a chapter from your favorite book",
        "Work on your coding project",
        "Review class notes",
        "Practice creative writing",
        "Learn a new skill online"
    ];
    
    const randomActivity = activities[Math.floor(Math.random() * activities.length)];
    
    alert(`Suggested activity for Period ${period}:\n\n${randomActivity}\n\nDuration: 30-45 minutes`);
}

function startTask(taskId) {
    alert(`Starting task ${taskId}. This would open a detailed task view in a real implementation.`);
}

function viewProgress() {
    alert('Progress tracking feature would show your academic and skill development progress over time.');
}

function showProfileModal() {
    const modal = new bootstrap.Modal(document.getElementById('profileModal'));
    modal.show();
}

function changeProfilePicture() {
    document.getElementById('hiddenProfileInput').click();
}

// Schedule Modal Functions
function showScheduleModal() {
    const modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
    modal.show();
    loadWeeklySchedule();
}

function loadWeeklySchedule() {
    // Show loading spinner
    document.getElementById('scheduleLoadingSpinner').style.display = 'block';
    document.getElementById('scheduleContent').style.display = 'none';
    document.getElementById('scheduleError').style.display = 'none';
    
    // Fetch schedule data from the server
    fetch('/api/student/schedule')
        .then(response => response.json())
        .then(data => {
            document.getElementById('scheduleLoadingSpinner').style.display = 'none';
            
            if (data.success && data.schedule && data.schedule.length > 0) {
                displayWeeklySchedule(data.schedule);
                document.getElementById('scheduleContent').style.display = 'block';
            } else {
                document.getElementById('scheduleError').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading schedule:', error);
            document.getElementById('scheduleLoadingSpinner').style.display = 'none';
            document.getElementById('scheduleError').style.display = 'block';
        });
}

function displayWeeklySchedule(scheduleData) {
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const periods = [1, 2, 3, 4, 5, 6, 7, 8];
    
    // Organize schedule data by day and period
    const scheduleByDay = {};
    days.forEach(day => {
        scheduleByDay[day] = {};
        periods.forEach(period => {
            scheduleByDay[day][period] = null;
        });
    });
    
    // Fill in the schedule data
    scheduleData.forEach(item => {
        if (scheduleByDay[item.day_of_week]) {
            scheduleByDay[item.day_of_week][item.period_number] = item;
        }
    });
    
    // Generate HTML table
    let html = `
        <div class="table-responsive">
            <table class="table table-bordered table-hover schedule-table">
                <thead class="table-primary">
                    <tr>
                        <th>Period</th>
                        <th>Time</th>
                        ${days.map(day => `<th class="text-center">${day}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
    `;
    
    periods.forEach(period => {
        html += `<tr>`;
        html += `<td class="fw-bold text-center">${period}</td>`;
        
        // Add time slot (assuming standard times)
        const timeSlots = {
            1: '09:00-10:00',
            2: '10:00-11:00', 
            3: '11:00-12:00',
            4: '12:00-13:00',
            5: '13:00-14:00',
            6: '14:00-15:00',
            7: '15:00-16:00',
            8: '16:00-17:00'
        };
        html += `<td class="text-center text-muted">${timeSlots[period] || ''}</td>`;
        
        days.forEach(day => {
            const classData = scheduleByDay[day][period];
            if (classData) {
                // Extract teacher name if it includes brackets
                let teacherInfo = '';
                if (classData.subject.includes('(') && classData.subject.includes(')')) {
                    const match = classData.subject.match(/\(([^)]+)\)/);
                    teacherInfo = match ? match[1] : '';
                }
                
                html += `
                    <td class="schedule-cell">
                        <div class="subject-name fw-bold text-primary">${classData.subject}</div>
                        <div class="time-info small text-muted">${classData.start_time || ''} - ${classData.end_time || ''}</div>
                        ${teacherInfo ? `<div class="teacher-info small text-success">${teacherInfo}</div>` : ''}
                    </td>
                `;
            } else {
                html += `<td class="text-center text-muted schedule-cell free-period">Free Period</td>`;
            }
        });
        
        html += `</tr>`;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        
        <div class="mt-3">
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-info-circle me-2"></i>Schedule Information</h6>
                    <ul class="list-unstyled small">
                        <li><i class="fas fa-clock me-2 text-primary"></i>Classes: 9:00 AM - 5:00 PM</li>
                        <li><i class="fas fa-coffee me-2 text-warning"></i>Lunch Break: Usually 12:00-1:00 PM</li>
                        <li><i class="fas fa-calendar-day me-2 text-success"></i>Total Periods: 8 per day</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-palette me-2"></i>Color Legend</h6>
                    <ul class="list-unstyled small">
                        <li><span class="badge bg-primary me-2">Subject</span>Regular Class</li>
                        <li><span class="badge bg-success me-2">Teacher</span>Teacher Code</li>
                        <li><span class="badge bg-secondary me-2">Free</span>Free Period</li>
                    </ul>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('scheduleContent').innerHTML = html;
}

function printSchedule() {
    const scheduleContent = document.getElementById('scheduleContent').innerHTML;
    const studentInfo = '{{ student[5] }}-{{ student[6] }}';
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>${studentInfo} - Weekly Schedule</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    @media print {
                        .schedule-table { font-size: 12px; }
                        .schedule-cell { padding: 8px 4px !important; }
                        .subject-name { font-size: 11px; }
                        .time-info, .teacher-info { font-size: 9px; }
                    }
                    body { padding: 20px; }
                    h1 { color: #007bff; margin-bottom: 20px; }
                </style>
            </head>
            <body>
                <h1>${studentInfo} - Weekly Class Schedule</h1>
                <p><strong>Generated on:</strong> ${new Date().toLocaleDateString()}</p>
                ${scheduleContent}
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

function uploadSelectedProfilePicture() {
    const input = document.getElementById('hiddenProfileInput');
    const file = input.files[0];
    
    if (file) {
        const formData = new FormData();
        formData.append('profile_picture', file);
        
        fetch('/api/upload_profile_picture', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the profile image
                const profileImage = document.getElementById('profileImage');
                if (profileImage.tagName === 'IMG') {
                    profileImage.src = data.image_url + '?t=' + new Date().getTime();
                } else {
                    // Replace div with img
                    const newImg = document.createElement('img');
                    newImg.id = 'profileImage';
                    newImg.src = data.image_url;
                    newImg.alt = 'Profile Picture';
                    newImg.className = 'profile-image';
                    newImg.style.cssText = 'width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #007bff;';
                    profileImage.parentNode.replaceChild(newImg, profileImage);
                }
                
                alert('Profile picture updated successfully!');
            } else {
                alert('Error uploading photo: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error uploading photo');
        });
    }
}

function previewProfilePicture() {
    const input = document.getElementById('profilePictureInput');
    const preview = document.getElementById('previewImage');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            // Replace div with img if needed
            if (preview.tagName === 'DIV') {
                preview.outerHTML = `<img id="previewImage" src="${e.target.result}" 
                    alt="Preview" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover;">`;
            } else {
                preview.src = e.target.result;
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
}
function uploadProfilePicture() {
    const input = document.getElementById('profilePictureInput');
    if (!input.files || !input.files[0]) {
        alert('Please select an image first');
        return;
    }
    
    const formData = new FormData();
    formData.append('profile_picture', input.files[0]);
    
    fetch('/api/upload_profile_picture', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const profileElement = document.getElementById('profileImage');
            
            // Replace the div/img with an img element
            if (profileElement.tagName === 'DIV') {
                profileElement.outerHTML = `<img id="profileImage" src="${data.image_url}" 
                    alt="Profile Picture" class="profile-image" 
                    style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #007bff;">`;
            } else {
                profileElement.src = data.image_url;
            }
            
            bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
            alert('Profile picture updated successfully!');
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error uploading photo');
}

function saveProfile() {
    const profileData = {
        first_name: document.getElementById('firstName').value,
        last_name: document.getElementById('lastName').value,
        email: document.getElementById('email').value,
        department: document.getElementById('department').value,
        section: document.getElementById('section').value,
        year: document.getElementById('year').value,
        date_of_birth: document.getElementById('dateOfBirth').value,
        mobile: document.getElementById('mobile').value
    };
    
    fetch('/api/update_student_profile', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(profileData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Profile updated successfully!');
            bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
            location.reload(); // Refresh to show updated data
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating profile');
    });
}

// Camera functionality
let cameraStream = null;

function openCameraModal() {
    const modal = new bootstrap.Modal(document.getElementById('cameraModal'));
    modal.show();
    
    // Start camera when modal opens
    startCamera();
}

async function startCamera() {
    try {
        const video = document.getElementById('cameraVideo');
        const constraints = {
            video: {
                width: { ideal: 400 },
                height: { ideal: 300 },
                facingMode: 'user' // Front camera for selfies
            }
        };
        
        cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = cameraStream;
        
        // Reset UI
        document.getElementById('captureBtn').style.display = 'inline-block';
        document.getElementById('retakeBtn').style.display = 'none';
        document.getElementById('usePhotoBtn').style.display = 'none';
        
    } catch (error) {
        console.error('Error accessing camera:', error);
        alert('Unable to access camera. Please check permissions and try again.');
    }
}

function capturePhoto() {
    const video = document.getElementById('cameraVideo');
    const canvas = document.getElementById('cameraCanvas');
    const context = canvas.getContext('2d');
    
    // Draw the video frame to canvas
    context.drawImage(video, 0, 0, 400, 300);
    
    // Hide video, show canvas with captured image
    video.style.display = 'none';
    canvas.style.display = 'block';
    
    // Update button visibility
    document.getElementById('captureBtn').style.display = 'none';
    document.getElementById('retakeBtn').style.display = 'inline-block';
    document.getElementById('usePhotoBtn').style.display = 'inline-block';
}

function retakePhoto() {
    const video = document.getElementById('cameraVideo');
    const canvas = document.getElementById('cameraCanvas');
    
    // Show video, hide canvas
    video.style.display = 'block';
    canvas.style.display = 'none';
    
    // Update button visibility
    document.getElementById('captureBtn').style.display = 'inline-block';
    document.getElementById('retakeBtn').style.display = 'none';
    document.getElementById('usePhotoBtn').style.display = 'none';
}

function useProfilePhoto() {
    const canvas = document.getElementById('cameraCanvas');
    
    // Convert canvas to blob
    canvas.toBlob(function(blob) {
        // Create form data
        const formData = new FormData();
        formData.append('profile_picture', blob, 'camera_photo.jpg');
        
        // Upload the photo
        fetch('/api/upload_profile_picture', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the profile image
                const profileImage = document.getElementById('profileImage');
                if (profileImage.tagName === 'IMG') {
                    profileImage.src = data.image_url + '?t=' + new Date().getTime();
                } else {
                    // Replace div with img
                    const newImg = document.createElement('img');
                    newImg.id = 'profileImage';
                    newImg.src = data.image_url;
                    newImg.alt = 'Profile Picture';
                    newImg.className = 'profile-image';
                    newImg.style.cssText = 'width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #007bff;';
                    profileImage.parentNode.replaceChild(newImg, profileImage);
                }
                
                // Close modal and stop camera
                stopCamera();
                const modal = bootstrap.Modal.getInstance(document.getElementById('cameraModal'));
                modal.hide();
                
                alert('Profile picture updated successfully!');
            } else {
                alert('Error uploading photo: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error uploading photo');
        });
    }, 'image/jpeg', 0.8);
}

function stopCamera() {
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
    }
}

// Stop camera when modal is closed
document.getElementById('cameraModal').addEventListener('hidden.bs.modal', function () {
    stopCamera();
    
    // Reset UI
    const video = document.getElementById('cameraVideo');
    const canvas = document.getElementById('cameraCanvas');
    video.style.display = 'block';
    canvas.style.display = 'none';
    
    document.getElementById('captureBtn').style.display = 'inline-block';
    document.getElementById('retakeBtn').style.display = 'none';
    document.getElementById('usePhotoBtn').style.display = 'none';
});

function saveRoutine() {
    alert('Routine saved! You can view it anytime from your dashboard.');
}

// Schedule enhancement functions
function updateCurrentStatus() {
    const now = new Date();
    const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
    const currentDay = now.toLocaleDateString('en-US', { weekday: 'long' });
    
    // Define period times for CSIT-A
    const periods = [
        { period: 1, start: '09:00', end: '10:00' },
        { period: 2, start: '10:00', end: '11:00' },
        { period: 3, start: '11:00', end: '12:00' },
        { period: 4, start: '12:00', end: '13:00' },
        { period: 5, start: '13:00', end: '14:00' },
        { period: 6, start: '14:00', end: '15:00' },
        { period: 7, start: '15:00', end: '16:00' },
        { period: 8, start: '16:00', end: '17:00' }
    ];
    
    let currentPeriod = null;
    let nextPeriod = null;
    let status = '';
    
    for (let i = 0; i < periods.length; i++) {
        const period = periods[i];
        if (currentTime >= period.start && currentTime < period.end) {
            currentPeriod = period.period;
            nextPeriod = i < periods.length - 1 ? periods[i + 1].period : null;
            status = `<span class="badge bg-success me-2">ONGOING</span>Period ${currentPeriod} (${period.start} - ${period.end})`;
            break;
        } else if (currentTime < period.start) {
            nextPeriod = period.period;
            const minutesToNext = Math.ceil((new Date(`1970-01-01T${period.start}:00`) - new Date(`1970-01-01T${currentTime}:00`)) / 60000);
            status = `<span class="badge bg-info me-2">UPCOMING</span>Period ${nextPeriod} starts in ${minutesToNext} minutes (${period.start})`;
            break;
        }
    }
    
    if (!currentPeriod && !nextPeriod) {
        if (currentTime >= '17:00') {
            status = '<span class="badge bg-secondary me-2">COMPLETE</span>All classes finished for today';
        } else {
            status = '<span class="badge bg-warning me-2">BREAK</span>Between classes';
        }
    }
    
    const statusElement = document.getElementById('current-status');
    if (statusElement) {
        statusElement.innerHTML = `
            <div class="d-flex align-items-center justify-content-between">
                <div>${status}</div>
                <small class="text-muted">${currentTime}</small>
            </div>
        `;
    }
}

// Generate to-do suggestions based on upcoming classes
function generateTodoSuggestions() {
    const suggestions = {
        'DLCO': ['Review digital circuits concepts', 'Prepare logic gate exercises', 'Study combinational circuits'],
        'DBMS': ['Review SQL queries', 'Practice database normalization', 'Study transaction concepts'],
        'PYTHON LAB': ['Prepare programming environment', 'Review Python syntax', 'Practice data structures'],
        'DBMS LAB': ['Set up database software', 'Review ER diagrams', 'Practice SQL commands'],
        'JAVA': ['Review OOP concepts', 'Practice inheritance examples', 'Study exception handling'],
        'UHV': ['Read assigned chapters', 'Prepare presentation topics', 'Review ethical case studies'],
        'DMGT': ['Practice mathematical problems', 'Review discrete structures', 'Study graph theory'],
        'Sports/Yoga': ['Wear appropriate attire', 'Bring water bottle', 'Prepare for physical activity']
    };
    
    return suggestions;
}

// Add quick action for period preparation
function prepareForPeriod(period, subject) {
    const suggestions = generateTodoSuggestions();
    const subjectKey = subject.split(' (')[0].trim();
    const todos = suggestions[subjectKey] || ['Review class materials', 'Prepare notebook', 'Check assignment deadlines'];
    
    let todoHtml = `<h6 class="text-primary mb-3">Preparation for Period ${period}: ${subjectKey}</h6><ul class="list-group list-group-flush">`;
    todos.forEach(todo => {
        todoHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">
            <span>${todo}</span>
            <input type="checkbox" class="form-check-input">
        </li>`;
    });
    todoHtml += '</ul>';
    
    // Show in a modal or alert
    alert(`Preparation checklist for ${subjectKey}:\n\n${todos.join('\n- ')}`);
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    updateCurrentStatus();
    
    // Update status every minute
    setInterval(updateCurrentStatus, 60000);
    
    // Add preparation buttons to schedule table
    const scheduleTable = document.querySelector('.table tbody');
    if (scheduleTable) {
        const rows = scheduleTable.querySelectorAll('tr');
        rows.forEach((row, index) => {
            const periodCell = row.querySelector('td:first-child');
            const subjectCell = row.querySelector('td:nth-child(3)');
            
            if (periodCell && subjectCell && !subjectCell.textContent.includes('Free')) {
                const period = index + 1;
                const subject = subjectCell.textContent.trim();
                
                // Add a small preparation button
                const actionCell = row.querySelector('td:last-child');
                if (actionCell && !actionCell.querySelector('.prep-btn')) {
                    actionCell.innerHTML += `<br><button class="btn btn-xs btn-outline-info prep-btn mt-1" onclick="prepareForPeriod(${period}, '${subject}')" title="Quick preparation checklist">
                        <i class="fas fa-clipboard-list"></i>
                    </button>`;
                }
            }
        });
    }
});
</script>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
    margin-bottom: 30px;
}

.timeline-marker {
    position: absolute;
    left: -35px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.timeline-content {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 3px solid #007bff;
}

.timeline-content h6 {
    margin-bottom: 5px;
    color: #495057;
}

.border-start {
    border-left-width: 4px !important;
}

.profile-image {
    transition: transform 0.2s;
}

.profile-image:hover {
    transform: scale(1.05);
}

/* Schedule Table Styles */
.schedule-table {
    font-size: 0.9rem;
}

.schedule-table th {
    background-color: #f8f9fa;
    font-weight: 600;
    border: 1px solid #dee2e6;
    text-align: center;
    vertical-align: middle;
}

.schedule-table td {
    border: 1px solid #dee2e6;
    text-align: center;
    vertical-align: middle;
    padding: 8px 4px;
}

.schedule-table .time-slot {
    background-color: #e9ecef;
    font-weight: 500;
    min-width: 80px;
}

.schedule-table .subject-cell {
    background-color: #fff;
    min-height: 40px;
}

.schedule-table .subject-name {
    font-weight: 600;
    color: #495057;
    margin-bottom: 2px;
}

.schedule-table .teacher-name {
    font-size: 0.8rem;
    color: #6c757d;
    margin-bottom: 1px;
}

.schedule-table .room-name {
    font-size: 0.75rem;
    color: #868e96;
}

.schedule-table .break-cell {
    background-color: #fff3cd;
    color: #856404;
    font-weight: 500;
}

.schedule-table .lunch-cell {
    background-color: #d1ecf1;
    color: #0c5460;
    font-weight: 500;
}

@media print {
    .schedule-table {
        font-size: 0.8rem;
    }
    
    .schedule-table th,
    .schedule-table td {
        padding: 4px 2px;
    }
}
</style>
{% endblock %}



