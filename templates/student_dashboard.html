{% extends "base.html" %}

{% block title %}Student Dashboard - School Management System{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Left Sidebar -->
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user me-2"></i>Profile
                    </h5>
                </div>
                <div class="card-body text-center">
                    <div class="profile-image-container mb-3">
                        {% if student[8] %}
                            <img id="profileImage" src="{{ student[8] }}" 
                                 alt="Profile Picture" class="profile-image" 
                                 style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #007bff;">
                        {% else %}
                            <div id="profileImage" class="profile-image d-flex align-items-center justify-content-center" 
                                 style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: 3px solid #007bff; color: white; font-size: 36px; font-weight: bold;">
                                {{ student[3][0] }}{{ student[4][0] }}
                            </div>
                        {% endif %}
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="changeProfilePicture()">
                                <i class="fas fa-camera me-1"></i>Change Photo
                            </button>
                        </div>
                    </div>
                    <h6 class="card-title">{{ student[3] }} {{ student[4] }}</h6>
                    <p class="text-muted">{{ student[5] }}-{{ student[6] }}</p>
                    <button class="btn btn-primary btn-sm" onclick="showProfileModal()">
                        <i class="fas fa-edit me-1"></i>Edit Profile
                    </button>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-calendar-check me-1"></i>View Attendance
                        </button>
                        <button class="btn btn-outline-success btn-sm">
                            <i class="fas fa-book me-1"></i>View Grades
                        </button>
                        <button class="btn btn-outline-info btn-sm">
                            <i class="fas fa-clock me-1"></i>Class Schedule
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-md-9">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-user-graduate me-2"></i>Welcome, {{ student[3] }} {{ student[4] }}
                </h1>
                <div class="text-muted">
                    <i class="fas fa-calendar me-1"></i>{{ current_date }}
                </div>
            </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ attendance_summary[1] or 0 }}</h4>
                            <p class="card-text">Present Days</p>
                        </div>
                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ attendance_summary[2] or 0 }}</h4>
                            <p class="card-text">Absent Days</p>
                        </div>
                        <i class="fas fa-times-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ free_periods|length }}</h4>
                            <p class="card-text">Free Periods Today</p>
                        </div>
                        <i class="fas fa-clock fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ suggested_tasks|length }}</h4>
                            <p class="card-text">Suggested Tasks</p>
                        </div>
                        <i class="fas fa-tasks fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Today's Timetable -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar-day me-2"></i>Today's Schedule
                    </h5>
                </div>
                <div class="card-body">
                    {% if timetable %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Period</th>
                                    <th>Time</th>
                                    <th>Subject</th>
                                    <th>Teacher</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for period in range(1, 9) %}
                                {% set period_info = timetable|selectattr('4', 'equalto', period)|first %}
                                <tr class="{% if period in free_periods %}table-light{% endif %}">
                                    <td>{{ period }}</td>
                                    <td>
                                        {% if period_info %}
                                            {{ period_info[6] }} - {{ period_info[7] }}
                                        {% else %}
                                            Free Period
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if period_info %}
                                            {{ period_info[5] }}
                                        {% else %}
                                            <span class="text-muted">Free</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if period_info %}
                                            Teacher {{ period_info[0] }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if period_info %}
                                            <span class="badge bg-success">Scheduled</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Free</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No classes scheduled for today</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Quick Actions & Free Periods -->
        <div class="col-lg-4 mb-4">
            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('attendance_qr') }}" class="btn btn-primary">
                            <i class="fas fa-qrcode me-2"></i>Mark Attendance
                        </a>
                        <button class="btn btn-outline-primary" onclick="generateDailyRoutine()">
                            <i class="fas fa-magic me-2"></i>Generate Daily Routine
                        </button>
                        <button class="btn btn-outline-success" onclick="viewProgress()">
                            <i class="fas fa-chart-line me-2"></i>View Progress
                        </button>
                    </div>
                </div>
            </div>

            <!-- Free Periods -->
            {% if free_periods %}
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clock me-2"></i>Free Periods Today
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for period in free_periods %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Period {{ period }}</span>
                            <button class="btn btn-sm btn-outline-primary" onclick="suggestActivity({{ period }})">
                                <i class="fas fa-lightbulb me-1"></i>Suggest
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Suggested Tasks -->
    {% if suggested_tasks %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tasks me-2"></i>Suggested Tasks for Free Periods
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for task in suggested_tasks %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card h-100 border-start border-{{ 'danger' if task[5] == 'high' else 'warning' if task[5] == 'medium' else 'success' }} border-4">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="card-title">{{ task[2] }}</h6>
                                        <span class="badge bg-{{ 'danger' if task[5] == 'high' else 'warning' if task[5] == 'medium' else 'success' }}">
                                            {{ task[5].title() }}
                                        </span>
                                    </div>
                                    <p class="card-text text-muted small">{{ task[3] }}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>{{ task[6] }} min
                                        </small>
                                        <small class="text-muted">{{ task[4] }}</small>
                                    </div>
                                </div>
                                <div class="card-footer bg-transparent">
                                    <button class="btn btn-sm btn-outline-primary w-100" onclick="startTask({{ task[0] }})">
                                        <i class="fas fa-play me-1"></i>Start Task
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Daily Routine Modal -->
<div class="modal fade" id="dailyRoutineModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-magic me-2"></i>Your Daily Smart Routine
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="routineContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Generating routine...</span>
                        </div>
                        <p class="mt-2">Generating your personalized daily routine...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveRoutine()">
                    <i class="fas fa-save me-1"></i>Save Routine
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<!-- Profile Edit Modal -->
<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="profileModalLabel">
                    <i class="fas fa-user-edit me-2"></i>Edit Profile
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="profileForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="firstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="firstName" value="{{ student[3] }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="lastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="lastName" value="{{ student[4] }}" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="studentId" class="form-label">Student ID</label>
                            <input type="text" class="form-control" id="studentId" value="{{ student[2] }}" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" value="{{ session.get('email', '') }}" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="department" class="form-label">Department</label>
                            <select class="form-control" id="department" required>
                                <option value="CSIT" {{ 'selected' if student[5] == 'CSIT' }}>CSIT</option>
                                <option value="CSD" {{ 'selected' if student[5] == 'CSD' }}>CSD</option>
                                <option value="CSE" {{ 'selected' if student[5] == 'CSE' }}>CSE</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="section" class="form-label">Section</label>
                            <select class="form-control" id="section" required>
                                <option value="A" {{ 'selected' if student[6] == 'A' }}>A</option>
                                <option value="B" {{ 'selected' if student[6] == 'B' }}>B</option>
                                <option value="C" {{ 'selected' if student[6] == 'C' }}>C</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="year" class="form-label">Year</label>
                            <select class="form-control" id="year" required>
                                <option value="1">1st Year</option>
                                <option value="2" selected>2nd Year</option>
                                <option value="3">3rd Year</option>
                                <option value="4">4th Year</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="dateOfBirth" class="form-label">Date of Birth</label>
                            <input type="date" class="form-control" id="dateOfBirth">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="mobile" class="form-label">Mobile Number</label>
                            <input type="tel" class="form-control" id="mobile" value="{{ student[7] if student[7] else '' }}">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Profile Picture Upload Modal -->
<div class="modal fade" id="profilePictureModal" tabindex="-1" aria-labelledby="profilePictureModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="profilePictureModalLabel">
                    <i class="fas fa-camera me-2"></i>Change Profile Picture
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div class="mb-3">
                        {% if student[8] %}
                            <img id="previewImage" src="{{ student[8] }}" 
                                 alt="Preview" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover;">
                        {% else %}
                            <div id="previewImage" class="d-flex align-items-center justify-content-center" 
                                 style="width: 150px; height: 150px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 48px; font-weight: bold; margin: 0 auto;">
                                {{ student[3][0] }}{{ student[4][0] }}
                            </div>
                        {% endif %}
                    </div>
                    <input type="file" class="form-control" id="profilePictureInput" accept="image/*" onchange="previewProfilePicture()">
                    <small class="text-muted">Choose an image file (JPG, PNG, GIF)</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="uploadProfilePicture()">Upload Picture</button>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
function generateDailyRoutine() {
    const modal = new bootstrap.Modal(document.getElementById('dailyRoutineModal'));
    modal.show();
    
    // Simulate routine generation
    setTimeout(() => {
        const content = `
            <div class="timeline">
                <div class="timeline-item">
                    <div class="timeline-marker bg-primary"></div>
                    <div class="timeline-content">
                        <h6>Morning Preparation (7:00 AM - 8:00 AM)</h6>
                        <p class="text-muted">Review today's schedule and prepare materials</p>
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-marker bg-success"></div>
                    <div class="timeline-content">
                        <h6>Classes (8:00 AM - 2:00 PM)</h6>
                        <p class="text-muted">Attend scheduled classes and mark attendance</p>
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-marker bg-warning"></div>
                    <div class="timeline-content">
                        <h6>Free Period Activities (11:15 AM - 12:00 PM)</h6>
                        <p class="text-muted">• Practice Math problems (30 min)<br>• Read literature (15 min)</p>
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-marker bg-info"></div>
                    <div class="timeline-content">
                        <h6>Afternoon Study (2:00 PM - 4:00 PM)</h6>
                        <p class="text-muted">Complete assignments and review class notes</p>
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-marker bg-secondary"></div>
                    <div class="timeline-content">
                        <h6>Skill Development (4:00 PM - 5:00 PM)</h6>
                        <p class="text-muted">Work on coding project or creative writing</p>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('routineContent').innerHTML = content;
    }, 2000);
}

function suggestActivity(period) {
    const activities = [
        "Practice Math problems",
        "Read a chapter from your favorite book",
        "Work on your coding project",
        "Review class notes",
        "Practice creative writing",
        "Learn a new skill online"
    ];
    
    const randomActivity = activities[Math.floor(Math.random() * activities.length)];
    
    alert(`Suggested activity for Period ${period}:\n\n${randomActivity}\n\nDuration: 30-45 minutes`);
}

function startTask(taskId) {
    alert(`Starting task ${taskId}. This would open a detailed task view in a real implementation.`);
}

function viewProgress() {
    alert('Progress tracking feature would show your academic and skill development progress over time.');
}

function showProfileModal() {
    const modal = new bootstrap.Modal(document.getElementById('profileModal'));
    modal.show();
function previewProfilePicture() {
    const input = document.getElementById('profilePictureInput');
    const preview = document.getElementById('previewImage');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            // Replace div with img if needed
            if (preview.tagName === 'DIV') {
                preview.outerHTML = `<img id="previewImage" src="${e.target.result}" 
                    alt="Preview" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover;">`;
            } else {
                preview.src = e.target.result;
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
}   if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function uploadProfilePicture() {
    const input = document.getElementById('profilePictureInput');
    if (!input.files || !input.files[0]) {
        alert('Please select an image first');
        return;
    }
    
    const formData = new FormData();
    formData.append('profile_picture', input.files[0]);
    
    fetch('/api/upload_profile_picture', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const profileElement = document.getElementById('profileImage');
            
            // Replace the div/img with an img element
            if (profileElement.tagName === 'DIV') {
                profileElement.outerHTML = `<img id="profileImage" src="${data.image_url}" 
                    alt="Profile Picture" class="profile-image" 
                    style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #007bff;">`;
            } else {
                profileElement.src = data.image_url;
            }
            
            bootstrap.Modal.getInstance(document.getElementById('profilePictureModal')).hide();
            alert('Profile picture updated successfully!');
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error uploading profile picture');
    });
}

function saveProfile() {
    const profileData = {
        first_name: document.getElementById('firstName').value,
        last_name: document.getElementById('lastName').value,
        email: document.getElementById('email').value,
        department: document.getElementById('department').value,
        section: document.getElementById('section').value,
        year: document.getElementById('year').value,
        date_of_birth: document.getElementById('dateOfBirth').value,
        mobile: document.getElementById('mobile').value
    };
    
    fetch('/api/update_student_profile', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(profileData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Profile updated successfully!');
            bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
            location.reload(); // Refresh to show updated data
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating profile');
    });
}

function saveRoutine() {
    alert('Routine saved! You can view it anytime from your dashboard.');
}
</script>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
    margin-bottom: 30px;
}

.timeline-marker {
    position: absolute;
    left: -35px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.timeline-content {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 3px solid #007bff;
}

.timeline-content h6 {
    margin-bottom: 5px;
    color: #495057;
}

.border-start {
    border-left-width: 4px !important;
}

.profile-image {
    transition: transform 0.2s;
}

.profile-image:hover {
    transform: scale(1.05);
}
</style>
{% endblock %}



